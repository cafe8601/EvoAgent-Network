# L2: Complete Data Structures & Field Specifications

## OH0 - KOSPI200 옵션호가 (228 bytes)

### InBlock (Input)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| optcode | string | 8 | 단축코드 (옵션코드) |

### OutBlock (Output - 220 bytes)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| hotime | string | 6 | 호가시간 (HHMMSS) |
| **offerho1** | double | 6.2 | 매도호가1 |
| **bidho1** | double | 6.2 | 매수호가1 |
| offerrem1 | long | 7 | 매도호가수량1 |
| bidrem1 | long | 7 | 매수호가수량1 |
| offercnt1 | long | 5 | 매도호가건수1 |
| bidcnt1 | long | 5 | 매수호가건수1 |
| offerho2 | double | 6.2 | 매도호가2 |
| bidho2 | double | 6.2 | 매수호가2 |
| offerrem2 | long | 7 | 매도호가수량2 |
| bidrem2 | long | 7 | 매수호가수량2 |
| offercnt2 | long | 5 | 매도호가건수2 |
| bidcnt2 | long | 5 | 매수호가건수2 |
| offerho3 | double | 6.2 | 매도호가3 |
| bidho3 | double | 6.2 | 매수호가3 |
| offerrem3 | long | 7 | 매도호가수량3 |
| bidrem3 | long | 7 | 매수호가수량3 |
| offercnt3 | long | 5 | 매도호가건수3 |
| bidcnt3 | long | 5 | 매수호가건수3 |
| offerho4 | double | 6.2 | 매도호가4 |
| bidho4 | double | 6.2 | 매수호가4 |
| offerrem4 | long | 7 | 매도호가수량4 |
| bidrem4 | long | 7 | 매수호가수량4 |
| offercnt4 | long | 5 | 매도호가건수4 |
| bidcnt4 | long | 5 | 매수호가건수4 |
| offerho5 | double | 6.2 | 매도호가5 |
| bidho5 | double | 6.2 | 매수호가5 |
| offerrem5 | long | 7 | 매도호가수량5 |
| bidrem5 | long | 7 | 매수호가수량5 |
| offercnt5 | long | 5 | 매도호가건수5 |
| bidcnt5 | long | 5 | 매수호가건수5 |
| **totofferrem** | long | 7 | 매도호가총수량 |
| **totbidrem** | long | 7 | 매수호가총수량 |
| totoffercnt | long | 5 | 매도호가총건수 |
| totbidcnt | long | 5 | 매수호가총건수 |
| optcode | string | 8 | 단축코드 |
| danhochk | string | 1 | 단일가호가여부 |
| alloc_gubun | string | 1 | 배분적용구분 |

### OH0 Parser Implementation
```python
class OH0Parser:
    """KOSPI200 옵션호가 파서"""

    def __init__(self, real: 'XAReal'):
        self.real = real

    def parse(self) -> dict:
        return {
            'hotime': self.real.GetFieldData("OutBlock", "hotime"),
            'ask': [
                {'price': float(self.real.GetFieldData("OutBlock", f"offerho{i}")),
                 'qty': int(self.real.GetFieldData("OutBlock", f"offerrem{i}")),
                 'cnt': int(self.real.GetFieldData("OutBlock", f"offercnt{i}"))}
                for i in range(1, 6)
            ],
            'bid': [
                {'price': float(self.real.GetFieldData("OutBlock", f"bidho{i}")),
                 'qty': int(self.real.GetFieldData("OutBlock", f"bidrem{i}")),
                 'cnt': int(self.real.GetFieldData("OutBlock", f"bidcnt{i}"))}
                for i in range(1, 6)
            ],
            'total_ask_qty': int(self.real.GetFieldData("OutBlock", "totofferrem")),
            'total_bid_qty': int(self.real.GetFieldData("OutBlock", "totbidrem")),
            'spread': self._calculate_spread()
        }

    def _calculate_spread(self) -> float:
        ask1 = float(self.real.GetFieldData("OutBlock", "offerho1"))
        bid1 = float(self.real.GetFieldData("OutBlock", "bidho1"))
        return ask1 - bid1
```

## OC0 - KOSPI200 옵션체결 (212 bytes)

### InBlock (Input)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| optcode | string | 8 | 단축코드 |

### OutBlock (Output - 204 bytes)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| chetime | string | 6 | 체결시간 (HHMMSS) |
| sign | string | 1 | 전일대비구분 (1:상한, 2:상승, 3:보합, 4:하한, 5:하락) |
| change | float | 6.2 | 전일대비 |
| drate | float | 6.2 | 등락율 |
| **price** | float | 6.2 | 현재가 |
| open | float | 6.2 | 시가 |
| high | float | 6.2 | 고가 |
| low | float | 6.2 | 저가 |
| cgubun | string | 1 | 체결구분 (1:매수, 2:매도) |
| cvolume | long | 6 | 체결량 |
| **volume** | long | 12 | 누적거래량 |
| value | long | 12 | 누적거래대금 |
| mdvolume | long | 12 | 매도누적체결량 |
| mdchecnt | long | 8 | 매도누적체결건수 |
| msvolume | long | 12 | 매수누적체결량 |
| mschecnt | long | 8 | 매수누적체결건수 |
| cpower | float | 9.2 | 체결강도 |
| offerho1 | float | 6.2 | 매도호가1 |
| bidho1 | float | 6.2 | 매수호가1 |
| openyak | long | 8 | 미결제약정수량 |
| k200jisu | float | 6.2 | KOSPI200지수 |
| eqva | float | 7.2 | KOSPI등가 |
| **theoryprice** | float | 6.2 | 이론가 |
| **impv** | float | 6.2 | 내재변동성 (IV) |
| openyakcha | long | 8 | 미결제약정증감 |
| **timevalue** | float | 6.2 | 시간가치 |
| jgubun | string | 2 | 장운영정보 |
| jnilvolume | long | 12 | 전일동시간대거래량 |
| optcode | string | 8 | 단축코드 |

### OC0 Parser Implementation
```python
class OC0Parser:
    """KOSPI200 옵션체결 파서"""

    def __init__(self, real: 'XAReal'):
        self.real = real

    def parse(self) -> dict:
        return {
            'time': self.real.GetFieldData("OutBlock", "chetime"),
            'price': float(self.real.GetFieldData("OutBlock", "price")),
            'change': float(self.real.GetFieldData("OutBlock", "change")),
            'change_pct': float(self.real.GetFieldData("OutBlock", "drate")),
            'volume': int(self.real.GetFieldData("OutBlock", "volume")),
            'trade_volume': int(self.real.GetFieldData("OutBlock", "cvolume")),
            'trade_side': 'BUY' if self.real.GetFieldData("OutBlock", "cgubun") == '1' else 'SELL',
            'ohlc': {
                'open': float(self.real.GetFieldData("OutBlock", "open")),
                'high': float(self.real.GetFieldData("OutBlock", "high")),
                'low': float(self.real.GetFieldData("OutBlock", "low")),
                'close': float(self.real.GetFieldData("OutBlock", "price"))
            },
            'greeks': {
                'iv': float(self.real.GetFieldData("OutBlock", "impv")),
                'theoretical': float(self.real.GetFieldData("OutBlock", "theoryprice")),
                'time_value': float(self.real.GetFieldData("OutBlock", "timevalue"))
            },
            'open_interest': int(self.real.GetFieldData("OutBlock", "openyak")),
            'oi_change': int(self.real.GetFieldData("OutBlock", "openyakcha")),
            'k200_index': float(self.real.GetFieldData("OutBlock", "k200jisu")),
            'power': float(self.real.GetFieldData("OutBlock", "cpower"))
        }
```

## OMG - KOSPI200 옵션민감도 (117 bytes)

### InBlock (Input)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| optcode | string | 8 | 옵션코드 |

### OutBlock (Output - 109 bytes)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| chetime | string | 6 | 체결시간 |
| actprice | float | 6.2 | 행사가 |
| k200jisu | float | 6.2 | KOSPI200지수 |
| fut200jisu | float | 6.2 | 선물가격 |
| price | float | 6.2 | 현재가 |
| **capimpv** | float | 6.2 | 대표내재변동성 |
| **impv** | float | 6.2 | 내재변동성 |
| **delt** | float | 7.4 | 델타 (블랙숄즈) |
| **gama** | float | 7.4 | 감마 (블랙숄즈) |
| **ceta** | float | 7.4 | 세타 (블랙숄즈) |
| **vega** | float | 7.4 | 베가 (블랙숄즈) |
| **rhox** | float | 7.4 | 로우 (블랙숄즈) |
| theoryprice | float | 6.2 | 이론가 (블랙숄즈) |
| bimpv | float | 6.2 | 전일가내재변동성 |
| offerimpv | float | 6.2 | 매도가내재변동성 |
| bidimpv | float | 6.2 | 매수가내재변동성 |
| optcode | string | 8 | 옵션코드 |

### OMG Parser Implementation
```python
class OMGParser:
    """KOSPI200 옵션민감도 (Greeks) 파서"""

    def __init__(self, real: 'XAReal'):
        self.real = real

    def parse(self) -> dict:
        return {
            'time': self.real.GetFieldData("OutBlock", "chetime"),
            'strike': float(self.real.GetFieldData("OutBlock", "actprice")),
            'underlying': {
                'k200': float(self.real.GetFieldData("OutBlock", "k200jisu")),
                'futures': float(self.real.GetFieldData("OutBlock", "fut200jisu"))
            },
            'price': float(self.real.GetFieldData("OutBlock", "price")),
            'greeks': {
                'delta': float(self.real.GetFieldData("OutBlock", "delt")),
                'gamma': float(self.real.GetFieldData("OutBlock", "gama")),
                'theta': float(self.real.GetFieldData("OutBlock", "ceta")),
                'vega': float(self.real.GetFieldData("OutBlock", "vega")),
                'rho': float(self.real.GetFieldData("OutBlock", "rhox"))
            },
            'iv': {
                'representative': float(self.real.GetFieldData("OutBlock", "capimpv")),
                'current': float(self.real.GetFieldData("OutBlock", "impv")),
                'prev_close': float(self.real.GetFieldData("OutBlock", "bimpv")),
                'ask': float(self.real.GetFieldData("OutBlock", "offerimpv")),
                'bid': float(self.real.GetFieldData("OutBlock", "bidimpv"))
            },
            'theoretical': float(self.real.GetFieldData("OutBlock", "theoryprice"))
        }
```

## FC0 - KOSPI200 선물체결 (211 bytes)

### OutBlock (Output - 203 bytes)
| Field | Type | Size | Description |
|-------|------|------|-------------|
| chetime | string | 6 | 체결시간 |
| sign | string | 1 | 전일대비구분 |
| change | float | 6.2 | 전일대비 |
| drate | float | 6.2 | 등락율 |
| **price** | float | 6.2 | 현재가 |
| open | float | 6.2 | 시가 |
| high | float | 6.2 | 고가 |
| low | float | 6.2 | 저가 |
| cgubun | string | 1 | 체결구분 |
| cvolume | long | 6 | 체결량 |
| **volume** | long | 12 | 누적거래량 |
| value | long | 12 | 누적거래대금 |
| mdvolume | long | 12 | 매도누적체결량 |
| mdchecnt | long | 8 | 매도누적체결건수 |
| msvolume | long | 12 | 매수누적체결량 |
| mschecnt | long | 8 | 매수누적체결건수 |
| cpower | float | 9.2 | 체결강도 |
| offerho1 | float | 6.2 | 매도호가1 |
| bidho1 | float | 6.2 | 매수호가1 |
| openyak | long | 8 | 미결제약정수량 |
| k200jisu | float | 6.2 | KOSPI200지수 |
| theoryprice | float | 6.2 | 이론가 |
| **kasis** | float | 6.2 | 괴리율 |
| **sbasis** | float | 6.2 | 시장BASIS |
| **ibasis** | float | 6.2 | 이론BASIS |
| openyakcha | long | 8 | 미결제약정증감 |
| jgubun | string | 2 | 장운영정보 |
| jnilvolume | long | 12 | 전일동시간대거래량 |
| futcode | string | 8 | 단축코드 |

### FC0 Parser Implementation
```python
class FC0Parser:
    """KOSPI200 선물체결 파서"""

    def __init__(self, real: 'XAReal'):
        self.real = real

    def parse(self) -> dict:
        return {
            'time': self.real.GetFieldData("OutBlock", "chetime"),
            'price': float(self.real.GetFieldData("OutBlock", "price")),
            'change': float(self.real.GetFieldData("OutBlock", "change")),
            'volume': int(self.real.GetFieldData("OutBlock", "volume")),
            'ohlc': {
                'open': float(self.real.GetFieldData("OutBlock", "open")),
                'high': float(self.real.GetFieldData("OutBlock", "high")),
                'low': float(self.real.GetFieldData("OutBlock", "low")),
                'close': float(self.real.GetFieldData("OutBlock", "price"))
            },
            'basis': {
                'spread': float(self.real.GetFieldData("OutBlock", "kasis")),
                'market': float(self.real.GetFieldData("OutBlock", "sbasis")),
                'theoretical': float(self.real.GetFieldData("OutBlock", "ibasis"))
            },
            'k200_index': float(self.real.GetFieldData("OutBlock", "k200jisu")),
            'open_interest': int(self.real.GetFieldData("OutBlock", "openyak"))
        }
```

## Real-time Subscription Manager

```python
class LSRealManager:
    """LS증권 실시간 데이터 관리자"""

    def __init__(self, res_path: str = "C:/LS_SEC/xingAPI/Res"):
        self.res_path = res_path
        self.reals = {}
        self.parsers = {
            'OH0': OH0Parser,
            'OC0': OC0Parser,
            'OMG': OMGParser,
            'FC0': FC0Parser
        }

    def subscribe(self, real_code: str, codes: list, callback):
        """실시간 데이터 구독"""
        real = win32com.client.Dispatch("XA_Real.XAReal")
        real.LoadFromResFile(f"{self.res_path}/{real_code}.res")

        handler = RealHandler(real_code, self.parsers[real_code], callback)
        win32com.client.WithEvents(real, handler)

        for code in codes:
            real.SetFieldData("InBlock", "optcode" if 'O' in real_code else "futcode", code)
            real.AdviseRealData()

        self.reals[real_code] = real
        return real

    def unsubscribe(self, real_code: str):
        if real_code in self.reals:
            self.reals[real_code].UnadviseRealData()
            del self.reals[real_code]

class RealHandler:
    def __init__(self, real_code: str, parser_class, callback):
        self.real_code = real_code
        self.parser_class = parser_class
        self.callback = callback

    def OnReceiveRealData(self, tr_code):
        parser = self.parser_class(self.parent)
        data = parser.parse()
        self.callback(self.real_code, data)
```

→ Load L3 for order management and production architecture
