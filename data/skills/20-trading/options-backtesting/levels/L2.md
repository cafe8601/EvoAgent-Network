# L2: Exit Conditions, Strategy Builder & Optimization

## Exit Condition System

### Exit Condition Types

```
┌─────────────────────────────────────────────────────────────┐
│                     청산 조건 종류                           │
├──────────────┬──────────────────────────────────────────────┤
│   수익 기반   │  profit_target: 목표 수익률 달성             │
│              │  rr_target: Risk:Reward 비율 달성            │
│              │  partial_profit: 부분 익절                   │
│              │  trailing_stop: 추적 손절                    │
├──────────────┼──────────────────────────────────────────────┤
│   손실 기반   │  stop_loss: 손절 라인                        │
├──────────────┼──────────────────────────────────────────────┤
│   시간 기반   │  time_exit: 특정 시간 청산                   │
│              │  max_holding_time: 최대 보유 시간            │
├──────────────┼──────────────────────────────────────────────┤
│   변동성     │  iv_crush: IV 급락 시 청산                   │
├──────────────┼──────────────────────────────────────────────┤
│   Greeks    │  delta_threshold: 델타 임계값 초과           │
└──────────────┴──────────────────────────────────────────────┘
```

### ExitConditionBuilder Usage

```python
from backtesting_engine import ExitConditionBuilder
from datetime import time

# 익절 조건: 100% 수익 시 청산
profit_exit = ExitConditionBuilder.profit_target(
    target_rate=100.0,  # 100% 수익
    priority=10         # 우선순위 (낮을수록 먼저 평가)
)

# R:R 기반 익절: 최대손실 대비 2배 수익 시
rr_exit = ExitConditionBuilder.rr_target(
    rr_ratio=2.0,       # R:R 1:2
    priority=10
)

# 손절 조건: -20% 손실 시 청산
stop_exit = ExitConditionBuilder.stop_loss(
    loss_rate=20.0,     # 20% 손실
    priority=5          # 익절보다 먼저 체크
)

# 추적 손절: 50% 수익 달성 후, 최고점 대비 20% 하락 시
trailing_exit = ExitConditionBuilder.trailing_stop(
    activation_rate=50.0,   # 50% 수익 시 활성화
    pullback_rate=20.0,     # 최고점 대비 20% 하락 시 청산
    priority=15
)

# 부분 익절: 30% 수익 시 절반 청산
partial_exit = ExitConditionBuilder.partial_profit(
    trigger_rate=30.0,  # 30% 수익 시
    exit_ratio=0.5,     # 50% 수량 청산
    priority=20
)

# 시간 청산: 15:15에 강제 청산
time_exit = ExitConditionBuilder.time_exit(
    exit_time=time(15, 15),
    priority=1          # 가장 높은 우선순위
)

# 최대 보유 시간: 30분 초과 시 청산
holding_exit = ExitConditionBuilder.max_holding_time(
    max_minutes=30,
    priority=2
)

# IV Crush 청산: IV가 15% 이상 급락 시
iv_exit = ExitConditionBuilder.iv_crush(
    iv_drop_threshold=0.15,  # 15% 하락
    priority=3
)

# 델타 임계값: 포지션 델타가 0.5 초과 시
delta_exit = ExitConditionBuilder.delta_threshold(
    max_delta=0.5,
    priority=25
)
```

### Priority Guidelines

```
1  : 시간 청산 (강제, 최우선)
2  : 최대 보유 시간
3  : IV Crush
5  : 손절
10 : 익절 / R:R 목표
15 : 추적 손절
20 : 부분 익절
25 : Greeks 기반
```

---

## CustomStrategyBuilder

### Complete Example

```python
from backtesting_engine import CustomStrategyBuilder, StrategyType
from datetime import time

strategy = (CustomStrategyBuilder()
    # 기본 설정
    .set_name("MyLongStraddle")
    .set_type(StrategyType.LONG_STRADDLE)

    # 자본 설정
    .set_capital(
        initial=100_000_000,    # 초기 자본 1억
        per_trade=10_000_000    # 거래당 1천만
    )

    # 거래 시간
    .set_trading_hours(
        start=time(9, 5),       # 09:05 시작
        end=time(15, 15),       # 15:15 종료
        force_close=time(15, 20) # 15:20 강제청산
    )

    # 비용 설정
    .set_costs(
        commission=0.0,         # 수수료 0
        slippage=1              # 슬리피지 1틱
    )

    # 청산 조건
    .add_rr_target(2.0)             # R:R 1:2
    .add_stop_loss(20.0)            # 20% 손절
    .add_trailing_stop(50.0, 20.0)  # 추적손절
    .add_iv_crush_exit(0.15)        # IV Crush 15%
    .add_max_holding_time(30)       # 최대 30분
    .add_time_exit(time(15, 15))    # 시간 청산

    .build())
```

---

## Grid Search Optimization

### Parameter Definition

```python
from backtesting_engine import (
    UniversalOptionOptimizer,
    OptimizationParameter,
    StrategyType,
)

# 최적화할 파라미터 정의
parameters = [
    OptimizationParameter(
        name='profit_target',
        min_value=50.0,
        max_value=150.0,
        step=25.0,
    ),
    OptimizationParameter(
        name='stop_loss',
        min_value=10.0,
        max_value=30.0,
        step=5.0,
    ),
    OptimizationParameter(
        name='trailing_activation',
        min_value=30.0,
        max_value=70.0,
        step=10.0,
    ),
    OptimizationParameter(
        name='trailing_pullback',
        min_value=10.0,
        max_value=30.0,
        step=5.0,
    ),
]
```

### Running Grid Search

```python
# 최적화 엔진 생성
optimizer = UniversalOptionOptimizer(
    strategy_type=StrategyType.LONG_STRADDLE,
    parameters=parameters,
)

# 그리드 서치 실행
optimization_results = optimizer.optimize_grid(
    snapshots=snapshots,
    metric='profit_factor',  # 최적화 기준
)

# 최적 결과 출력
best = optimization_results['best_result']
print(f"최적 파라미터:")
for name, value in best['params'].items():
    print(f"  {name}: {value}")
print(f"\n최적 성과:")
print(f"  Profit Factor: {best['profit_factor']:.2f}")
print(f"  승률: {best['win_rate']:.1%}")
print(f"  총 손익: {best['total_pnl']:,.0f}원")
```

### Optimization Metrics

| Metric | Description | Formula |
|--------|-------------|---------|
| `TP` | Total Profit | 총 손익 |
| `TG` | Total Gain Rate | 총 수익률 |
| `TPI` | Total Profit Index | 수익 지수 |
| `CAGR` | Compound Annual Growth | 연복리 수익률 |
| `PM` | Profit to MDD | 손익 / MDD |
| `GM` | Gain to MDD | 수익률 / MDD% |
| `P2M` | Profit to MDD² | 손익 / MDD² |
| `profit_factor` | Profit Factor | 총익 / 총손 |

---

## Genetic Algorithm Optimization

### Configuration

```python
from backtesting_engine import (
    OptionsOptimizer,
    OptimizerConfig,
    OptimizationMethod,
    ParameterRange,
)

config = OptimizerConfig(
    method=OptimizationMethod.GENETIC,
    ga_population_size=50,           # 인구 수
    ga_generations=100,              # 세대 수
    ga_crossover_rate=0.8,           # 교차 확률
    ga_mutation_rate=0.1,            # 돌연변이 확률
    ga_elitism_count=5,              # 엘리트 보존 수
    ga_random_variables_per_generation=3,  # 세대당 랜덤 주입
    max_stagnant_generations=20,     # 정체 허용 세대
    convergence_threshold=0.001,     # 수렴 임계값
)

optimizer = OptionsOptimizer(config)
result = optimizer.optimize(
    strategy_template, parameter_ranges,
    contract_code, start_date, end_date
)
```

### Walk-Forward Analysis

```python
# Walk-forward 최적화
result = optimizer.walk_forward_optimize(
    strategy_template, parameter_ranges,
    contract_code, start_date, end_date
)

# 결과 (Train/Validation/Test 분리)
print(f"Train Score: {result.train_score:.4f}")
print(f"Validation Score: {result.validation_score:.4f}")
print(f"Test Score: {result.test_score:.4f}")
print(f"Overfitting Ratio: {result.overfitting_ratio:.2f}")
```

### Cross-Validation

```python
# K-fold 교차 검증
result = optimizer.cross_validate(
    strategy_template, parameter_ranges,
    contract_code, start_date, end_date
)

print(f"CV Mean: {result.cv_mean:.4f}")
print(f"CV Std: {result.cv_std:.4f}")
print(f"CV Scores: {result.cv_scores}")
```

---

## MarketSnapshot Data Structure

### Creating Snapshots

```python
from backtesting_engine import (
    MarketSnapshot,
    OptionTick,
    GreeksData,
    OptionType,
)
from datetime import datetime

# Greeks 데이터 (OMG 피드에서 수신)
call_greeks = GreeksData(
    delta=0.5,
    gamma=0.05,
    theta=-0.02,
    vega=0.15,
    iv=20.0
)

put_greeks = GreeksData(
    delta=-0.5,
    gamma=0.05,
    theta=-0.02,
    vega=0.15,
    iv=20.0
)

# 옵션 틱 데이터
call_tick = OptionTick(
    timestamp=datetime.now(),
    code="201FA330",           # 콜 종목코드
    price=3.50,
    bid_price=3.48,
    ask_price=3.52,
    greeks=call_greeks,
    option_type=OptionType.CALL,
    strike_price=330.0,
    k200_index=330.0,
    futures_price=330.5,
)

put_tick = OptionTick(
    timestamp=datetime.now(),
    code="201FM330",           # 풋 종목코드
    price=3.40,
    bid_price=3.38,
    ask_price=3.42,
    greeks=put_greeks,
    option_type=OptionType.PUT,
    strike_price=330.0,
)

# 스냅샷 생성
snapshot = MarketSnapshot(
    timestamp=datetime.now(),
    k200_index=330.0,
    futures_price=330.5,
    atm_strike=330.0,
    option_ticks={
        call_tick.code: call_tick,
        put_tick.code: put_tick,
    },
)
```

---

## Backtest Results Analysis

### Result Structure

```python
results = engine.run(snapshots)

# 요약 통계
print(f"전략: {results['strategy_name']}")
print(f"총 거래: {results['total_trades']}")
print(f"승리: {results['winning_trades']}")
print(f"패배: {results['losing_trades']}")
print(f"승률: {results['win_rate']:.1%}")

# 손익 분석
print(f"총 손익: {results['total_pnl']:,.0f}원")
print(f"평균 손익: {results['avg_pnl']:,.0f}원")
print(f"평균 수익: {results['avg_win']:,.0f}원")
print(f"평균 손실: {results['avg_loss']:,.0f}원")
print(f"Profit Factor: {results['profit_factor']:.2f}")

# 리스크 분석
print(f"최대 낙폭(MDD): {results['max_drawdown']:.1f}%")
print(f"수익률: {results['return_rate']:.2f}%")
print(f"최종 자본: {results['final_capital']:,.0f}원")
```

### Trade-by-Trade Analysis

```python
for trade in results['trades']:
    print(f"\n[{trade['entry_time']} ~ {trade['exit_time']}]")
    print(f"  청산 사유: {trade['exit_type']}")
    print(f"  손익: {trade['net_pnl']:,.0f}원 ({trade['pnl_rate']:.2f}%)")
    print(f"  K200: {trade['entry_k200']:.2f} → {trade['exit_k200']:.2f}")

    # 레그별 상세
    for leg in trade['leg_details']:
        print(f"    {leg['option_type']} {leg['direction']}: "
              f"{leg['entry_price']:.2f} → {leg['exit_price']:.2f}, "
              f"PnL: {leg['pnl']:,.0f}원")
```

→ Load L3 for custom strategy implementation and advanced patterns

