# L2: Implementation Patterns

## Kiwoom OpenAPI+ Implementation

### Core Wrapper Class
```python
from PyQt5.QAxContainer import QAxWidget
import pythoncom

class Kiwoom:
    def __init__(self, user_class, gubun: str):
        self.dict_bool = {
            '로그인': False, 'TR수신': False, 'TR다음': False
        }
        self.ocx = QAxWidget('KHOPENAPI.KHOpenAPICtrl.1')

        # Core event handlers
        self.ocx.OnEventConnect.connect(self.on_event_connect)
        self.ocx.OnReceiveTrData.connect(self.on_receive_tr_data)

        # Role-specific handlers
        if gubun == 'Receiver':
            self.ocx.OnReceiveRealData.connect(user_class.OnReceiveRealData)
        elif gubun == 'Trader':
            self.ocx.OnReceiveMsg.connect(user_class.on_receive_msg)
            self.ocx.OnReceiveChejanData.connect(user_class.on_receive_chejan_data)

    def comm_connect(self):
        self.ocx.dynamicCall('CommConnect()')
        while not self.dict_bool['로그인']:
            pythoncom.PumpWaitingMessages()
```

### TR Data Request Pattern
```python
def block_request(self, *args, **kwargs) -> pd.DataFrame:
    trcode = args[0].lower()
    self.dict_item = parse_dat(trcode)  # Parse .enc/.dat files

    for key, value in kwargs.items():
        if key.lower() not in ['output', 'next']:
            self.ocx.dynamicCall('SetInputValue(QString, QString)', key, value)

    self.dict_bool['TR수신'] = False
    self.ocx.dynamicCall('CommRqData(QString, QString, int, QString)',
                         rqname, trcode, next_flag, screen_no)

    # Wait with rate limiting (250ms minimum)
    sleeptime = datetime.datetime.now() + datetime.timedelta(seconds=0.25)
    while not self.dict_bool['TR수신'] or datetime.datetime.now() < sleeptime:
        pythoncom.PumpWaitingMessages()

    return self.tr_df
```

### Real-time Data Registration
```python
def set_real_reg(self, rreg: list):
    """
    rreg = [screen_no, code_list, fid_list, opt_type]
    opt_type: 0=replace, 1=add
    """
    self.ocx.dynamicCall('SetRealReg(QString, QString, QString, QString)',
                         str(rreg[0]), rreg[1], rreg[2], str(rreg[3]))

def OnReceiveRealData(self, code: str, realtype: str, realdata: str):
    if realtype == '옵션호가잔량':
        매도호가1 = self.kiwoom.get_comm_real_data(code, 41)
        매수호가1 = self.kiwoom.get_comm_real_data(code, 51)
    elif realtype == '옵션시세':
        현재가 = abs(int(self.kiwoom.get_comm_real_data(code, 10)))
```

### Order Execution (Futures/Options)
```python
def send_order(self, order: list) -> str:
    """
    order = [rqname, screen_no, accno, code, qty,
             price, hogagb, ordergb, orderno, orgorderno]
    hogagb: "1"=지정가, "2"=조건부지정가, "3"=시장가, "4"=최유리지정가
    ordergb: 1=신규매수, 2=신규매도, 3=매수취소, 4=매도취소, 5=매수정정, 6=매도정정
    """
    return self.ocx.dynamicCall(
        'SendOrderFo(QString, QString, QString, QString, int, QString, QString, int, QString, QString)',
        order
    )
```

## LS Securities xingAPI Implementation

### Session Management
```python
import win32com.client

class XASession:
    def __init__(self):
        self.login_state = False
        self.com_obj = win32com.client.Dispatch("XA_Session.XASession")
        win32com.client.WithEvents(self.com_obj, XASessionEvents).connect(self)

    def Login(self, server: int, user_id: str, password: str, cert: str):
        if server == 0:  # Demo
            self.com_obj.ConnectServer("demo.ls-sec.co.kr", 20001)
        else:  # Real
            self.com_obj.ConnectServer("api.ls-sec.co.kr", 20001)
        self.com_obj.Login(user_id, password, cert, 0, False)

        while not self.login_state:
            pythoncom.PumpWaitingMessages()

class XASessionEvents:
    def OnLogin(self, code, msg):
        if code == "0000":
            self.parent.login_state = True
```

### TR Query Pattern
```python
class XAQuery:
    def __init__(self, res_file: str):
        self.query = win32com.client.Dispatch("XAQuery.XAQuery")
        self.query.LoadFromResFile(f"C:/LS_SEC/xingAPI/Res/{res_file}.res")
        self.received = False
        win32com.client.WithEvents(self.query, self)

    def request(self, inputs: dict, block_name: str = "InBlock"):
        for field, value in inputs.items():
            self.query.SetFieldData(f"{self.res}{block_name}", field, 0, value)
        self.query.Request(False)

        while not self.received:
            pythoncom.PumpWaitingMessages()

    def OnReceiveData(self, tr_code):
        self.received = True
```

### Real-time Data Subscription
```python
class XAReal:
    def __init__(self, res_file: str):
        self.real = win32com.client.Dispatch("XA_Real.XAReal")
        self.real.LoadFromResFile(f"C:/LS_SEC/xingAPI/Res/{res_file}.res")
        win32com.client.WithEvents(self.real, self)

    def subscribe(self, code: str):
        self.real.AdviseRealData()
        self.real.SetFieldData("InBlock", "optcode", code)

    def unsubscribe(self):
        self.real.UnAdviseRealData()

    def OnReceiveRealData(self, tr_code):
        price = self.real.GetFieldData("OutBlock", "price")
        volume = self.real.GetFieldData("OutBlock", "volume")
```

## Common TR Codes

### Kiwoom OpenAPI+
| TR Code | Description | Use Case |
|---------|-------------|----------|
| opt10001 | 주식기본정보 | 종목 기본정보 조회 |
| opt10054 | 옵션일별주가 | 옵션 일봉 데이터 |
| opw00004 | 계좌평가현황 | 계좌 잔고 조회 |
| opw20007 | 선옵잔고현황 | 선물옵션 잔고 |

### LS Securities xingAPI
| TR Code | Description | Use Case |
|---------|-------------|----------|
| t2301 | 옵션현재가(시세)조회 | 옵션 시세 |
| t8414 | 선물옵션틱차트 | 틱봉 데이터 |
| t8415 | 선물옵션분차트 | 분봉 데이터 |
| CFOAT00100 | 선물옵션정상주문 | 주문 실행 |
| CFOAT00200 | 선물옵션정정주문 | 주문 정정 |
| CFOAT00300 | 선물옵션취소주문 | 주문 취소 |

## Fast Server Selection (Low Latency)

### Kiwoom Fast Server
```python
@staticmethod
def change_connect_ip():
    """빠른 서버 IP로 변경 (저지연 트레이딩용)"""
    with open('C:/OpenAPI/system/ip_api.dat') as f:
        text = f.read()
    fixed_ip = text.split('IP=')[1].split('PORT=')[0].strip()

    with open('C:/OpenAPI/system/opcomms.ini') as f:
        text = f.read()
    text = f"{text.split('CONNECTED_IP=')[0]}CONNECTED_IP={fixed_ip}\n\n[PORTINFO]{text.split('[PORTINFO]')[1]}"

    with open('C:/OpenAPI/system/opcomms.ini', 'w') as f:
        f.write(text)
```

## FID (Field ID) Reference

### 옵션시세 (Real-time Option Price)
| FID | Field | Description |
|-----|-------|-------------|
| 10 | 현재가 | Current price |
| 11 | 전일대비 | Change from prev close |
| 12 | 등락율 | Change % |
| 15 | 거래량 | Volume |
| 20 | 체결시간 | Trade time |

### 옵션호가잔량 (Real-time Option Order Book)
| FID | Field | Description |
|-----|-------|-------------|
| 41 | 매도호가1 | Ask price 1 |
| 51 | 매수호가1 | Bid price 1 |
| 61 | 매도호가잔량1 | Ask volume 1 |
| 71 | 매수호가잔량1 | Bid volume 1 |

→ Load L3 for advanced patterns and production architecture
